/*
 * PR Reviewer Assignment Service (Test Task, Fall 2025)
 *
 * No description provided (generated by Openapi Generator https://github.com/openapitools/openapi-generator)
 *
 * API version: 1.0.0
 * Generated by: OpenAPI Generator (https://openapi-generator.tech)
 */

/*
 * PR Reviewer Assignment Service (Test Task, Fall 2025)
 */

package openapi

import (
	"avito-test/internal/domain"
	"avito-test/internal/usecase"
	"errors"
	"net/http"

	"github.com/gin-gonic/gin"
)

type PullRequestsAPI struct {
	prUC usecase.PullRequest
}

func NewPullRequestsAPI(prUC usecase.PullRequest) PullRequestsAPI {
	return PullRequestsAPI{prUC: prUC}
}

type pullRequestResponse struct {
	PullRequestID     string   `json:"pull_request_id"`
	PullRequestName   string   `json:"pull_request_name"`
	AuthorID          string   `json:"author_id"`
	Status            string   `json:"status"`
	AssignedReviewers []string `json:"assigned_reviewers"`
}

func mapPullRequestToResponse(pr *domain.PullRequest) pullRequestResponse {
	return pullRequestResponse{
		PullRequestID:     pr.ID,
		PullRequestName:   pr.Name,
		AuthorID:          pr.AuthorID,
		Status:            string(pr.Status),
		AssignedReviewers: pr.AssignedReviewersID,
	}
}

// POST /pullRequest/create
// Создать PR и автоматически назначить до 2 ревьюверов из команды автора

func (api *PullRequestsAPI) PullRequestCreatePost(c *gin.Context) {
	var body struct {
		PullRequestID   string `json:"pull_request_id" binding:"required"`
		PullRequestName string `json:"pull_request_name" binding:"required"`
		AuthorID        string `json:"author_id" binding:"required"`
	}
	if err := c.ShouldBindJSON(&body); err != nil {
		writeError(c, http.StatusBadRequest, errCodeBadRequest, err.Error())
		return
	}

	pr := &domain.PullRequest{
		ID:       body.PullRequestID,
		Name:     body.PullRequestName,
		AuthorID: body.AuthorID,
	}

	created, err := api.prUC.CreatePullRequest(c.Request.Context(), pr)

	switch {
	case errors.Is(err, usecase.ErrAuthorNotFound),
		errors.Is(err, usecase.ErrTeamNotFound):
		writeError(c, http.StatusNotFound, errCodeNotFound, err.Error())
		return

	case errors.Is(err, usecase.ErrPullRequestAlreadyExists):
		writeError(c, http.StatusConflict, errCodePRExists, err.Error())
		return

	case err != nil:
		writeError(c, http.StatusInternalServerError, errCodeInternal, err.Error())
		return
	}

	resp := struct {
		PR pullRequestResponse `json:"pr"`
	}{
		PR: mapPullRequestToResponse(created),
	}

	c.JSON(http.StatusCreated, resp)
}

// POST /pullRequest/merge
// Пометить PR как MERGED (идемпотентная операция)

func (api *PullRequestsAPI) PullRequestMergePost(c *gin.Context) {
	var body struct {
		PullRequestID string `json:"pull_request_id" binding:"required"`
	}
	if err := c.ShouldBindJSON(&body); err != nil {
		writeError(c, http.StatusBadRequest, errCodeBadRequest, err.Error())
		return
	}

	// Act
	pr, err := api.prUC.MergePullRequest(c.Request.Context(), body.PullRequestID)

	// Assert
	switch {
	case errors.Is(err, usecase.ErrPullRequestNotFound):
		writeError(c, http.StatusNotFound, errCodeNotFound, err.Error())
		return
	case err != nil:
		writeError(c, http.StatusInternalServerError, errCodeInternal, err.Error())
		return
	}

	resp := struct {
		PR pullRequestResponse `json:"pr"`
	}{
		PR: mapPullRequestToResponse(pr),
	}

	c.JSON(http.StatusOK, resp)
}

// POST /pullRequest/reassign
// Переназначить конкретного ревьювера на другого из его команды

func (api *PullRequestsAPI) PullRequestReassignPost(c *gin.Context) {
	var body struct {
		PullRequestID string `json:"pull_request_id" binding:"required"`
		OldUserID     string `json:"old_user_id" binding:"required"`
	}
	if err := c.ShouldBindJSON(&body); err != nil {
		writeError(c, http.StatusBadRequest, errCodeBadRequest, err.Error())
		return
	}

	// Act
	requestOwner, newReviewer, err := api.prUC.ReassignRequest(c.Request.Context(), body.PullRequestID, body.OldUserID)

	// Assert
	switch {
	case errors.Is(err, usecase.ErrPullRequestNotFound),
		errors.Is(err, usecase.ErrMemberNotFound):
		// PR или пользователь не найден
		writeError(c, http.StatusNotFound, errCodeNotFound, err.Error())
		return

	case errors.Is(err, usecase.ErrPullRequestIsMerged):
		writeError(c, http.StatusConflict, errCodePRMerged, err.Error())
		return

	case errors.Is(err, usecase.ErrCannotFindActiveMembers):
		writeError(c, http.StatusConflict, errCodeNoCandidate, err.Error())
		return

	case err != nil:
		writeError(c, http.StatusInternalServerError, errCodeInternal, err.Error())
		return
	}

	resp := struct {
		PR         pullRequestResponse `json:"requestOwner"`
		ReplacedBy string              `json:"replaced_by"`
	}{
		PR:         mapPullRequestToResponse(requestOwner),
		ReplacedBy: newReviewer.ID,
	}

	c.JSON(http.StatusOK, resp)
}
